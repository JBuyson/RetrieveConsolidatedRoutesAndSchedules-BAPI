<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="getRoutes-CallTravelOnTip-subFlow" doc:id="7a0fe4b4-145c-49f3-a0f5-a38355d1903b" >
		<set-variable value="#[&quot;/api/&quot; ++ (vars.transportType default &quot;&quot;) ++ p('http.requester.travelOnTip.routesPath')]" doc:name="Set Variable" doc:id="1302be7e-1abd-47f1-bcbf-abb174ac5f11" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="9fe9cf75-c024-4ddd-81f0-21afa8f0f246" cachingStrategy-ref="Caching_Strategy">
					<http:request method="GET" doc:name="Request" doc:id="39c53a6b-7a6a-4338-80af-6b933da645ff" config-ref="HTTP_Request_configuration_TraveolOnTip-SAPI" path="#[vars.resourcePath]">
					<http:headers><![CDATA[#[output application/java
---
{
	transactionId : vars.transactionId
}]]]></http:headers>
				</http:request>
					<ee:transform doc:name="Transform Message" doc:id="aa0f55b5-852c-49be-8e0a-3ae325b23464">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var LocationMapping = readUrl("classpath://json/LocationCodeMapping","application/json")
---
payload map(value,index) ->{
    "companyCode": vars.transportCompany,
    "originLocation": {
      "locationCode": value.originLocation.locationCode,
      "locationDesc": (LocationMapping filter($.locationCode == value.originLocation.locationCode))[0].locationDesc
    },
    "destinationLocation": {
      "locationCode": value.destinationLocation.locationCode,
      "locationDesc": (LocationMapping filter($.locationCode == value.destinationLocation.locationCode))[0].locationDesc
    }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				</ee:cache>
	</sub-flow>
	<sub-flow name="getRoutes-CallFastGo-subFlow" doc:id="20f92577-61d2-491b-916f-f290e87403df" >
		<set-variable value="#[&quot;/api/&quot; ++ (vars.transportType default &quot;&quot;) ++ p('http.requester.fastGo.routesPath')]" doc:name="Set Variable" doc:id="306ca838-7cab-4dfc-b920-6da0fdfb9215" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="6d12ea76-e9c3-41ec-95db-be0a80de31da" cachingStrategy-ref="Caching_Strategy">
					<http:request method="GET" doc:name="Request" doc:id="425247a5-cf10-4b55-8701-992a771bd870" config-ref="HTTP_Request_configuration_FastGo-SAPI" path="#[vars.resourcePath]">
					<http:headers><![CDATA[#[output application/java
---
{
	transactionId : vars.transactionId
}]]]></http:headers>
				</http:request>
					<ee:transform doc:name="Transform Message" doc:id="ed8a2dc0-e193-43dd-8d56-cb65aa7815da">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var LocationMapping = readUrl("classpath://json/LocationCodeMapping","application/json")
---
payload map(value,index) ->{
    "companyCode": vars.transportCompany,
    "originLocation": {
      "locationCode": value.departureLocationCode,
      "locationDesc": (LocationMapping filter($.locationCode == value.departureLocationCode))[0].locationDesc    
    },
    "destinationLocation": {
      "locationCode": value.arrivalLocationCode,
      "locationDesc": (LocationMapping filter($.locationCode == value.arrivalLocationCode))[0].locationDesc   
    }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				</ee:cache>
	</sub-flow>
	<sub-flow name="getRoutes-implementationSub_Flow" doc:id="4a9f46af-c89a-4d6c-a7fb-9f7ee7aa9ba4" >
		<set-variable value="Routes" doc:name="Set Variable" doc:id="025e87ae-ac6d-4b41-94e1-c751ddc56221" variableName="resource"/>
		<choice doc:name="Choice" doc:id="e131d4eb-b375-4b47-8340-9233ca9d2d1a" >
			<when expression="#[vars.transportCompany == 'fastGo']">
				<flow-ref doc:name="Flow Reference" doc:id="8fc8fe7e-6fcd-47fa-b864-914e696c95ad" name="getRoutes-CallFastGo-subFlow" />
			</when>
			<when expression="#[vars.transportCompany == 'travelOnTip']">
				<flow-ref doc:name="Flow Reference" doc:id="b782c1c1-00a6-440c-9dba-6562610448af" name="getRoutes-CallTravelOnTip-subFlow" />
			</when>
			<otherwise>
				<scatter-gather doc:name="Scatter-Gather" doc:id="1db95699-1a7e-494f-b5c4-6ffdbb768032" >
					<route >
						<set-variable value="fastGo" doc:name="Set Variable" doc:id="673549dd-cdf6-43e6-aa6e-416e8cc03dfa" variableName='transportCompany'/>
						<flow-ref doc:name="Flow Reference" doc:id="22c318c1-e110-43d0-a912-541b4f07e3bd" name="getRoutes-CallFastGo-subFlow"/>
					</route>
					<route >
						<set-variable value="travelOnTip" doc:name="Set Variable" doc:id="b484fcd7-1316-428b-9926-484fa2678ce2" variableName="transportCompany"/>
						<flow-ref doc:name="Flow Reference" doc:id="6178f13a-0f6f-4669-a19c-c06c2c835b51" name="getRoutes-CallTravelOnTip-subFlow"/>
					</route>
				</scatter-gather>
				<set-payload value="#[%dw 2.0&#10;output application/json&#10;---&#10;(payload.'0'.payload default []) ++ (payload.'1'.payload default [])]" doc:name="Set Payload" doc:id="00333cac-73b9-4389-a2ef-3f544758cb90" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
